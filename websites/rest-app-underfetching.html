<html>
<head>
    <meta charset="UTF-8" />
    <title>rest-app with underfetching</title>
</head>
<script>
    async function getWeatherData(){
        const weatherTable = document.getElementById("weatherTable")
		const city = document.getElementById("city").value;
		const start_date = document.getElementById("start_date").value;
		const days = document.getElementById("days").value;

        //take the time and store it and then start the search
        let startTime = performance.timeOrigin + performance.now();


        try {
            // first request get station_id
            const cityResponse = await fetch(`http://localhost:3000/cities?city_name=${city}`);
            const cityData = await cityResponse.json();
            const station_id = cityData.station_id;

            // second request get weather data
            const weatherResponse = await fetch(`http://localhost:3000/weatherdata?station_id=${station_id}&start_date=${start_date}&days=${days}`);
            const weatherData = await weatherResponse.json();

            if (!weatherResponse.ok || !cityResponse.ok) {
                throw new Error("Network response failed");
            }

            //measures the time and stores in csv format, this is done together with a tampermonkey script
            let endTime = performance.timeOrigin + performance.now();

            let elapsedTime = endTime - startTime;

            let currentCity = localStorage.getItem('currentCity');
            localStorage.removeItem('currentCity');

            let currentDate= localStorage.getItem('currentDate');
            localStorage.removeItem('currentDate');

            let csvData = localStorage.getItem('csvData');
            csvData += currentCity + "," + currentDate + "," + elapsedTime + "," + startTime + "," + endTime + "\n";
            localStorage.setItem("csvData",csvData);

            //console.log(weatherData);
            //console.log(cityData);

            //writes out the data in a table
            /*let output =``;
            weatherData.forEach(element => {
                output +=`<tr>
                    <td>${element.station_id}</td>
			        <td>${element.observation_time}</td>
                    <td>${element.wind_direction}</td>
                    <td>${element.wind_speed}</td>
                    <td>${element.visibility}</td>
                    <td>${element.temperature}</td>
                    <td>${element.dew_point}</td>
                    <td>${element.atmospheric_pressure}</td>
                    <td>${element.ceiling}</td>
                    <td>${cityData.city_name}</td>
                    <td>${cityData.station_name}</td>
			    </tr>`;                
            });
            weatherTable.innerHTML = output;*/
        } catch (error) {
            console.error(error.message);
        }
    }
</script>

<body>
	<div>
		<h2>Weather-search with Rest API</h2>
		<form method='POST'>
            <select id="city" name="city">
                <option value="London">London </option>
                <option value="Paris">Paris</option>
                <option value="Madrid">Madrid</option>
                <option value="Berlin">Berlin</option>
                <option value="Krakow">Krakow</option>
                <option value="Beijing">Beijing</option>
                <option value="Cairo">Cairo</option>
                <option value="Toronto">Toronto</option>
                <option value="San Francisco">San Francisco</option>
                <option value="Pittsburgh">Pittsburgh</option>
                <option value="Buffalo">Buffalo</option>
                <option value="Sydney">Sydney</option>
            </select>
            <input type="date" id="start_date" name="start_date" value="2014-01-01" min="2014-01-01" max="2024-01-01"/>
            <input type="number" id="days" name="days" value="100">
            <button type="button" id="fetchDataBtn" onclick="getWeatherData()">Fetch Weather Data</button>
        </form>
	</div>
    <table>
        <thead>
            <tr>
                <th>Station ID</th>
                <th>Observation Time</th>
                <th>Wind Direction</th>
                <th>Wind Speed</th>
                <th>Visibility</th>
                <th>Temperature</th>
                <th>Dew Point</th>
                <th>Pressure</th>
                <th>Ceiling</th>
                <th>City Name</th>
                <th>Station Name</th>
            </tr>
        </thead>
        <tbody id="weatherTable">
        </tbody>
    </table>
    
</body>
</html>